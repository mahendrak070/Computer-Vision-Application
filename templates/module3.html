<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 3 - Feature Detection</title>
    <link rel="stylesheet" href="/static/css/module.css">
</head>
<body>
    <div class="header">
        <h1>Module 3: Feature Detection & Segmentation</h1>
        <a href="/dashboard" class="back-btn">Back to Dashboard</a>
    </div>

    <div class="container">
        <div class="section">
            <h2>Feature Detection</h2>
            <div class="info-box">
                <strong>Features:</strong> Gradient computation, edge detection, corner detection, and advanced segmentation techniques.
            </div>

            <div class="controls">
                <input type="file" id="imageInput" accept="image/*" onchange="loadImage(event)">
                <button class="btn-primary" onclick="document.getElementById('imageInput').click()">Upload Image</button>
                <button class="btn-secondary" id="processBtn" onclick="processImage()" disabled>Process Features</button>
                <button class="btn-danger" onclick="resetModule()">Reset</button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-text" id="progressText">Processing...</div>
            </div>

            <div class="loading-spinner" id="spinner"></div>

            <div class="results-grid" id="results" style="display:none;"></div>
        </div>
    </div>

    <script>
        let currentImage = null;

        function loadImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                document.getElementById('processBtn').disabled = false;
                document.getElementById('results').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        async function processImage() {
            if (!currentImage) return;

            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const spinner = document.getElementById('spinner');
            const processBtn = document.getElementById('processBtn');

            progressContainer.classList.add('active');
            spinner.classList.add('active');
            processBtn.disabled = true;

            try {
                progressFill.style.width = '30%';
                progressFill.textContent = '30%';
                progressText.textContent = 'Computing gradients...';

                const response = await fetch('/api/module3/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: currentImage })
                });

                progressFill.style.width = '80%';
                progressFill.textContent = '80%';
                progressText.textContent = 'Detecting features...';

                const data = await response.json();

                if (data.success) {
                    progressFill.style.width = '100%';
                    progressFill.textContent = '100%';
                    progressText.textContent = 'Complete!';

                    displayResults(data);

                    setTimeout(() => {
                        progressContainer.classList.remove('active');
                    }, 1000);
                } else {
                    alert('Processing failed: ' + (data.message || 'Unknown error'));
                    progressContainer.classList.remove('active');
                }
            } catch (err) {
                alert('Error: ' + err.message);
                progressContainer.classList.remove('active');
            } finally {
                spinner.classList.remove('active');
                processBtn.disabled = false;
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'grid';

            const features = [
                { name: 'Original', key: 'original' },
                { name: 'Gradient Magnitude', key: 'gradient_magnitude' },
                { name: 'Gradient Angle', key: 'gradient_angle' },
                { name: 'Edges', key: 'edges' },
                { name: 'Corners', key: 'corners' }
            ];

            resultsDiv.innerHTML = features.map(feature => {
                if (data[feature.key]) {
                    return `
                        <div class="result-card">
                            <h4>${feature.name}</h4>
                            <img src="${data[feature.key]}" alt="${feature.name}">
                            <button class="btn-secondary" onclick="downloadImage('${data[feature.key]}', '${feature.name.toLowerCase().replace(' ', '_')}.jpg')">
                                Download
                            </button>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }

        function resetModule() {
            currentImage = null;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('results').style.display = 'none';
            document.getElementById('imageInput').value = '';
        }

        window.addEventListener('beforeunload', resetModule);
    </script>
</body>
</html>
